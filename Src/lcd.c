//
// Created by Albert on 20.05.2020.
//

#include "lcd.h"

//SPI handle for sending via HAL functions
SPI_HandleTypeDef SPI_Handle;

//Default bytemap
const unsigned char bytemap [] = {
        //first row
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00,
        //second row
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80,
        0x70, 0x0C, 0x02, 0x01, 0x01, 0x02, 0x0C, 0x70, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0xFF, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0xFF, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00,
        //third row
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x0E, 0x30, 0x40, 0x80, 0x80, 0x40, 0x30,
        0x0E, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF, 0x80, 0x80, 0x80, 0x80,
        0x80, 0x80, 0x80, 0x80, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00,
        //fourth row
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0x40, 0x20, 0x10, 0x08, 0x04, 0x02, 0x01, 0x01,
        0x01, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x80, 0x60, 0x18, 0x06, 0x01, 0x06, 0x18, 0x60, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x80, 0x60, 0x10, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00,
        //fifth row
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80,
        0x40, 0x20, 0x10, 0x08, 0x04, 0x02, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x06, 0x18, 0x60, 0x80, 0x60,
        0x18, 0x06, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00,
        //sixth row
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00,
};

// Sine bytemap
const uint8_t SineBytemap[] = {

        0x00, 0x80 ,0x70, 0x0C, 0x02, 0x01, 0x01, 0x02, 0x0C, 0x70,
        0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00,

        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x01, 0x0E, 0x30, 0x40, 0x80, 0x80, 0x40, 0x30, 0x0E,
        0x01, 0x00
};

// Square wave bytemap
const uint8_t SquareBytemap[] = {

        0x00, 0xFF, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01,
        0xFF, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00,

        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0xFF, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0xFF,
        0x00
};

// Sawtooth wave bytemap
const uint8_t SawtoothBytemap[] = {

        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80,
        0x40, 0x20, 0x10, 0x08, 0x04, 0x02, 0x01, 0x01, 0x01, 0xFF,
        0x00,

        0x00, 0x80, 0x40, 0x20, 0x10, 0x08, 0x04, 0x02, 0x01, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF,
        0x00
};

// Triangle wave bytemap
const uint8_t TriangleBytemap[] = {

        0x00, 0x80, 0x60, 0x18, 0x06, 0x01, 0x06, 0x18, 0x60, 0x80,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0x60, 0x10,
        0x00,

        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01,
        0x06, 0x18, 0x60, 0x80, 0x60, 0x18, 0x06, 0x01, 0x00, 0x00,
        0x00,
};


void LCD_SendCommand(uint8_t command)
{

    HAL_GPIO_WritePin(LCD_GPIO, CE_PIN, GPIO_PIN_RESET);

    HAL_GPIO_WritePin(LCD_GPIO, COMD_PIN, COMMAND);

    HAL_SPI_Transmit(&SPI_Handle, &command, sizeof(command), 10);

    HAL_GPIO_WritePin(LCD_GPIO, CE_PIN, GPIO_PIN_SET);

    HAL_GPIO_WritePin(LCD_GPIO, COMD_PIN, DATA);

}

void LCD_SendData(uint8_t data)
{

    HAL_GPIO_WritePin(LCD_GPIO, CE_PIN, GPIO_PIN_RESET);

    HAL_GPIO_WritePin(LCD_GPIO, COMD_PIN, DATA);

    HAL_SPI_Transmit(&SPI_Handle, &data, sizeof(data), 10);

    HAL_GPIO_WritePin(LCD_GPIO, CE_PIN, GPIO_PIN_SET);

}

void LCD_SetCursor(uint8_t row, uint8_t column)
{
    LCD_SendCommand(SET_X_ADDR | column);
    LCD_SendCommand(SET_Y_ADDR | row);
}

void LCD_SendFrame()
{
    for(size_t index = 0; index < sizeof(bytemap); ++index)
    {
        LCD_SendData(*(bytemap + index));
    }
}

void LCD_DrawSine(void)
{
    LCD_SetCursor(SINE_UPPER_ROW, SINE_START_COL);

    for(size_t index = 0; index < SINE_BYTEMAP_SIZE; ++index)
    {
        if( ((SINE_BYTEMAP_SIZE) / 2) == index)
        {
            LCD_SetCursor(SINE_LOWER_ROW, SINE_START_COL);
        }
        LCD_SendData((uint8_t) SineBytemap[index]);
    }
}

void LCD_InverseSine(void)
{
    LCD_SetCursor(SINE_UPPER_ROW, SINE_START_COL);

    for(size_t index = 0; index < SINE_BYTEMAP_SIZE; ++index)
    {
        if( ((SINE_BYTEMAP_SIZE) / 2) == index)
        {
            LCD_SetCursor(SINE_LOWER_ROW, SINE_START_COL);
        }
        LCD_SendData((uint8_t) ~SineBytemap[index]);
    }
}

void LCD_DrawSquare(void)
{
    LCD_SetCursor(SQUARE_UPPER_ROW, SQUARE_START_COL);

    for(size_t index = 0; index < SQUARE_BYTEMAP_SIZE; ++index)
    {
        if( ((SQUARE_BYTEMAP_SIZE) / 2) == index)
        {
            LCD_SetCursor(SQUARE_LOWER_ROW, SQUARE_START_COL);
        }
        LCD_SendData((uint8_t) SquareBytemap[index]);
    }
}

void LCD_InverseSquare(void)
{
    LCD_SetCursor(SQUARE_UPPER_ROW, SQUARE_START_COL);

    for(size_t index = 0; index < SQUARE_BYTEMAP_SIZE; ++index)
    {
        if( ((SQUARE_BYTEMAP_SIZE) / 2) == index)
        {
            LCD_SetCursor(SQUARE_LOWER_ROW, SQUARE_START_COL);
        }
        LCD_SendData((uint8_t) ~SquareBytemap[index]);
    }
}

void LCD_DrawSawtooth(void)
{
    LCD_SetCursor(SAWTOOTH_UPPER_ROW, SAWTOOTH_START_COL);

    for(size_t index = 0; index < SAWTOOTH_BYTEMAP_SIZE; ++index)
    {
        if( ((SAWTOOTH_BYTEMAP_SIZE) / 2) == index)
        {
            LCD_SetCursor(SAWTOOTH_LOWER_ROW, SAWTOOTH_START_COL);
        }
        LCD_SendData((uint8_t) SawtoothBytemap[index]);
    }
}

void LCD_InverseSawtooth(void)
{
    LCD_SetCursor(SAWTOOTH_UPPER_ROW, SAWTOOTH_START_COL);

    for(size_t index = 0; index < SAWTOOTH_BYTEMAP_SIZE; ++index)
    {
        if( ((SAWTOOTH_BYTEMAP_SIZE) / 2) == index)
        {
            LCD_SetCursor(SAWTOOTH_LOWER_ROW, SAWTOOTH_START_COL);
        }
        LCD_SendData((uint8_t) ~SawtoothBytemap[index]);
    }
}

void LCD_DrawTriangle(void)
{
    LCD_SetCursor(TRIANGLE_UPPER_ROW, TRIANGLE_START_COL);

    for(size_t index = 0; index < TRIANGLE_BYTEMAP_SIZE; ++index)
    {
        if( ((TRIANGLE_BYTEMAP_SIZE) / 2) == index)
        {
            LCD_SetCursor(TRIANGLE_LOWER_ROW, TRIANGLE_START_COL);
        }
        LCD_SendData((uint8_t) TriangleBytemap[index]);
    }
}

void LCD_InverseTriangle(void)
{
    LCD_SetCursor(TRIANGLE_UPPER_ROW, TRIANGLE_START_COL);

    for(size_t index = 0; index < TRIANGLE_BYTEMAP_SIZE; ++index)
    {
        if( ((TRIANGLE_BYTEMAP_SIZE) / 2) == index)
        {
            LCD_SetCursor(TRIANGLE_LOWER_ROW, TRIANGLE_START_COL);
        }
        LCD_SendData((uint8_t) ~TriangleBytemap[index]);
    }
}

bool LCD_Init(void)
{
    __GPIOA_CLK_ENABLE();
    GPIO_InitTypeDef gpio;

    HAL_GPIO_WritePin(LCD_GPIO, CE_PIN | COMD_PIN | RST_PIN, GPIO_PIN_SET);

    gpio.Pin =  CE_PIN | COMD_PIN | RST_PIN;
    gpio.Mode = GPIO_MODE_OUTPUT_PP;
    gpio.Pull = GPIO_NOPULL;
    gpio.Speed = GPIO_SPEED_HIGH;

    HAL_GPIO_Init(LCD_GPIO, &gpio);

    //Initializes SPI1 for oneway communication with LCD
    if(false == SPI1_Init())
    {
        UART_WriteString("LCD init failed\n\r");
        return false;
    }

    // Quick reset of LCD screen
    HAL_GPIO_WritePin(LCD_GPIO, RST_PIN, GPIO_PIN_RESET);
    HAL_GPIO_WritePin(LCD_GPIO, RST_PIN, GPIO_PIN_SET);

    LCD_SendCommand(FUNC_SET | CHIP_ON | EXTENDED_INSTR);

    LCD_SendCommand(TEMP_CONTROL | TEMP_COE_2);

    LCD_SendCommand(BIAS_CONTROL | BIAS_4);

    LCD_SendCommand(VOP_CONTROL | 0x3f);

    LCD_SendCommand(FUNC_SET | BASIC_INSTR | CHIP_ON | HORIZONTAL_ADDR);

    LCD_SendCommand(DISPLAY_CONTROL | DISPLAY_NORM);

    // Sends default bytemap to LCD
    LCD_SendFrame();

    return true;
}